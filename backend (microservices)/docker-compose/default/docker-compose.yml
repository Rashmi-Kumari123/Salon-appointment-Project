version: "3.9"

services:
  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: Rashmi@123
      MYSQL_DATABASE: salon_db
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 10
      interval: 10s
      start_period: 10s

  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    container_name: zookeeper
    ports:
      - "2181:2181"
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 2181 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    depends_on:
      zookeeper:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  eurekaserver:
    build:
      context: ./eurekaserver
      dockerfile: Dockerfile
    container_name: eurekaserver
    ports:
      - "8070:8070"
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:8070/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  user-service:
    build:
      context: ./user-service
      dockerfile: Dockerfile
    container_name: user-service
    ports:
      - "5001:5001"  # HTTP port
      - "9090:9090"  # gRPC port
    environment:
      SPRING_APPLICATION_NAME: user
      SERVER_PORT: 5001
      GRPC_SERVER_PORT: 9090
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-for-jwt-token-generation-must-be-at-least-256-bits-long}
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5001/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  salon:
    build:
      context: ./salon
      dockerfile: Dockerfile
    container_name: salon
    ports:
      - "5002:5002"  # HTTP port
      - "9091:9091"  # gRPC port
    environment:
      SPRING_APPLICATION_NAME: salon
      SERVER_PORT: 5002
      GRPC_SERVER_PORT: 9091
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      user-service:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5002/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  category:
    build:
      context: ./category
      dockerfile: Dockerfile
    container_name: category
    ports:
      - "5004:5004"  # HTTP port
      - "9092:9092"  # gRPC port
    environment:
      SPRING_APPLICATION_NAME: category
      SERVER_PORT: 5004
      GRPC_SERVER_PORT: 9092
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
      GRPC_CLIENT_SALON_SERVICE_ADDRESS: static://salon:9091
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      user-service:
        condition: service_healthy
      salon:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5004/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  service-offering:
    build:
      context: ./service-offering
      dockerfile: Dockerfile
    container_name: service-offering
    ports:
      - "5005:5005"  # HTTP port
      - "9095:9095"  # gRPC port (changed from 9093 to avoid conflict with booking)
    environment:
      SPRING_APPLICATION_NAME: service-offering
      SERVER_PORT: 5005
      GRPC_SERVER_PORT: 9095
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
      GRPC_CLIENT_SALON_SERVICE_ADDRESS: static://salon:9091
      GRPC_CLIENT_CATEGORY_SERVICE_ADDRESS: static://category:9092
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      user-service:
        condition: service_healthy
      salon:
        condition: service_healthy
      category:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5005/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  payment:
    build:
      context: ./payment
      dockerfile: Dockerfile
    container_name: payment
    ports:
      - "5006:5006"  # HTTP port
      - "9094:9094"  # gRPC port
    environment:
      SPRING_APPLICATION_NAME: payment
      SERVER_PORT: 5006
      GRPC_SERVER_PORT: 9094
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
      GRPC_CLIENT_SALON_SERVICE_ADDRESS: static://salon:9091
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
      user-service:
        condition: service_healthy
      salon:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5006/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  booking:
    build:
      context: ./booking
      dockerfile: Dockerfile
    container_name: booking
    ports:
      - "5003:5003"  # HTTP port
      - "9093:9093"  # gRPC port
    environment:
      SPRING_APPLICATION_NAME: booking
      SERVER_PORT: 5003
      GRPC_SERVER_PORT: 9093
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
      GRPC_CLIENT_SALON_SERVICE_ADDRESS: static://salon:9091
      GRPC_CLIENT_SERVICE_OFFERING_ADDRESS: static://service-offering:9095
      GRPC_CLIENT_PAYMENT_ADDRESS: static://payment:9094
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
      user-service:
        condition: service_healthy
      salon:
        condition: service_healthy
      service-offering:
        condition: service_healthy
      payment:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5003/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  notifications:
    build:
      context: ./notifications
      dockerfile: Dockerfile
    container_name: notifications
    ports:
      - "5007:5007"  # HTTP port only, no gRPC server
    environment:
      SPRING_APPLICATION_NAME: notification
      SERVER_PORT: 5007
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
      GRPC_CLIENT_BOOKING_SERVICE_ADDRESS: static://booking:9093
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      kafka:
        condition: service_healthy
      user-service:
        condition: service_healthy
      booking:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5007/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  review:
    build:
      context: ./review
      dockerfile: Dockerfile
    container_name: review
    ports:
      - "5008:5008"  # HTTP port only, no gRPC server
    environment:
      SPRING_APPLICATION_NAME: review
      SERVER_PORT: 5008
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/salon_db?createDatabaseIfNotExist=true&useSSL=false&serverTimezone=Asia/Kolkata&allowPublicKeyRetrieval=true
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: Rashmi@123
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      GRPC_CLIENT_USER_SERVICE_ADDRESS: static://user-service:9090
      GRPC_CLIENT_SALON_SERVICE_ADDRESS: static://salon:9091
    depends_on:
      mysql:
        condition: service_healthy
      eurekaserver:
        condition: service_healthy
      user-service:
        condition: service_healthy
      salon:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5008/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  gateway-server:
    build:
      context: ./gateway-server
      dockerfile: Dockerfile
    container_name: gateway-server
    ports:
      - "5000:5000"  # HTTP port only, no gRPC
    environment:
      SPRING_APPLICATION_NAME: gateway-server
      SERVER_PORT: 5000
      EUREKA_CLIENT_SERVICEURL_DEFAULTZONE: http://eurekaserver:8070/eureka/
      JWT_SECRET: ${JWT_SECRET:-your-256-bit-secret-key-for-jwt-token-generation-must-be-at-least-256-bits-long}
    depends_on:
      eurekaserver:
        condition: service_healthy
    networks:
      - mywebsitedev
    healthcheck:
      test: ["CMD-SHELL", "curl --fail --silent localhost:5000/actuator/health/readiness | grep UP || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

volumes:
  mysql_data:

networks:
  mywebsitedev:
    driver: bridge
